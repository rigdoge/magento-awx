---
- name: 安装 Kubernetes Dashboard
  hosts: all
  gather_facts: no
  vars:
    dashboard_version: v2.7.0
  tasks:
    - name: 创建 kubernetes-dashboard 命名空间
      shell: |
        kubectl create namespace kubernetes-dashboard || true
      register: namespace_result

    - name: 创建 Dashboard 配置
      copy:
        dest: /tmp/dashboard.yaml
        content: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - kind: ServiceAccount
            name: admin-user
            namespace: kubernetes-dashboard

    - name: 部署 Dashboard
      shell: |
        echo "=== 开始部署 Kubernetes Dashboard ==="
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/{{ dashboard_version }}/aio/deploy/recommended.yaml
        kubectl apply -f /tmp/dashboard.yaml
        
        echo "等待 Dashboard Pod 就绪..."
        for i in $(seq 1 30); do
          echo "等待中... $i/30"
          if kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard | grep -q "Running"; then
            echo "Dashboard Pod 已就绪"
            break
          fi
          sleep 5
        done
        
        echo -e "\n=== 创建访问令牌 ==="
        kubectl -n kubernetes-dashboard create token admin-user
        
        echo -e "\n=== Dashboard 访问信息 ==="
        echo "1. 运行以下命令启动代理:"
        echo "   kubectl proxy"
        echo
        echo "2. 访问以下地址:"
        echo "   http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/"
        echo
        echo "3. 使用上面的令牌登录"
      register: deploy_result

    - name: 显示部署结果
      debug:
        msg: "{{ deploy_result.stdout_lines }}" 